<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>calling u back | Nidom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="cocoa框架基于C语言除了良好的运行性能外还有个重要的优点就是强大丰富的C库支持。ios开发中C库和oc的互相调用对于开发者来说也是不小的挑战，国外网站看到一篇文章，翻译给大家，个人进行了精简：
我有时看到这样的问题：“我怎么把一个oc方法转化为方法指针，是在编译的时候转化还是本来就是cocoa框架的一种形式”。一个程序员错误的这样问了，就会让这个问题变得狭隘。其实这个问题应该这么问：“ How">
<meta property="og:type" content="article">
<meta property="og:title" content="calling u back">
<meta property="og:url" content="http://nidom.top/article/20130909/calling-u-back/index.html">
<meta property="og:site_name" content="Nidom">
<meta property="og:description" content="cocoa框架基于C语言除了良好的运行性能外还有个重要的优点就是强大丰富的C库支持。ios开发中C库和oc的互相调用对于开发者来说也是不小的挑战，国外网站看到一篇文章，翻译给大家，个人进行了精简：
我有时看到这样的问题：“我怎么把一个oc方法转化为方法指针，是在编译的时候转化还是本来就是cocoa框架的一种形式”。一个程序员错误的这样问了，就会让这个问题变得狭隘。其实这个问题应该这么问：“ How">
<meta property="og:image" content="http://nidom.top/images/blog/2013090901.png">
<meta property="og:image" content="http://nidom.top/images/blog/2013090902.png">
<meta property="og:image" content="http://nidom.top/images/blog/2013090903.png">
<meta property="og:image" content="http://nidom.top/images/blog/2013090904.png">
<meta property="og:image" content="http://nidom.top/images/blog/2013090905.png">
<meta property="og:updated_time" content="2015-05-27T05:34:08.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="calling u back">
<meta name="twitter:description" content="cocoa框架基于C语言除了良好的运行性能外还有个重要的优点就是强大丰富的C库支持。ios开发中C库和oc的互相调用对于开发者来说也是不小的挑战，国外网站看到一篇文章，翻译给大家，个人进行了精简：
我有时看到这样的问题：“我怎么把一个oc方法转化为方法指针，是在编译的时候转化还是本来就是cocoa框架的一种形式”。一个程序员错误的这样问了，就会让这个问题变得狭隘。其实这个问题应该这么问：“ How">
  
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="undefined" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Nidom</a></h1>
		</hgroup>

		

		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Nidom</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="undefined" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">Nidom</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-calling-u-back" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/article/20130909/calling-u-back/" class="article-date">
  	<time datetime="2013-09-09T00:03:15.000Z" itemprop="datePublished">2013-09-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      calling u back
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS开发/">iOS开发</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>cocoa框架基于C语言除了良好的运行性能外还有个重要的优点就是强大丰富的C库支持。ios开发中C库和oc的互相调用对于开发者来说也是不小的挑战，国外网站看到一篇文章，翻译给大家，个人进行了精简：</p>
<p>我有时看到这样的问题：“我怎么把一个oc方法转化为方法指针，是在编译的时候转化还是本来就是cocoa框架的一种形式”。一个程序员错误的这样问了，就会让这个问题变得狭隘。其实这个问题应该这么问：“ How do I use an Objective-C method as a callback for a C library?” 意思就是怎么用c库回调oc的消息（方法）。把oc方法转化为c方法指针可能是解决这个问题的一种方法，真的这样吗？ 不是，为什么？Inside the Bracket 这片文章告诉我们OC的方法其实也是C函数，只不过是在调用实参之前就封装了两个参数，self和selector. 这正是我们不能直接把oc方法作为c库回调的原因。 比例你用一个C库进行文本处理，它有一个回调方法并且给定了string和一个bool变量，你需要写个函数来转化字符串，简单写法:<br><a id="more"></a><br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *encheferizeString (<span class="built_in">NSString</span> *string,</span><br><span class="line">                             <span class="built_in">BOOL</span> useChicken, <span class="keyword">void</span> *info);</span><br><span class="line"> 在C库中进行注册：</span><br><span class="line">SetModificationCallback (textManger, encheferizeString, infoPointer);</span><br></pre></td></tr></table></figure></p>
<p>C库运行工作的时候最终需要调用你写的encheferizeString方法，所以C库调用你的方法和3个参数:string，the boolean flag ， an info pointer（通常这三个参数被理解为用户数据，内容，一个固定指针或者只是隐藏一些数据）在内存中，参数看起来这么排列</p>
<img src="/images/blog/2013090901.png">  
<p>不过，你现在要说 ，我已经有了一个方法了，我要使用已有的方法！</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">-</span> (<span class="tag">NSString</span> *) <span class="rule"><span class="attribute">encheferizeString</span>:<span class="value"> (NSString *) string</span><br><span class="line">                      useChicken: (BOOL) useChicken</span></span>;</span><br></pre></td></tr></table></figure>
<p>当然你可以用IMP 从-methodForSelector: 进行转化，然后再转化为C库可用的回调方法，你可以试一下：</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IMP <span class="function"><span class="keyword">method</span> =</span><br><span class="line">  [<span class="title">cheferizer</span> <span class="title">methodForSelector</span>:</span>@<span class="keyword">selector</span>(encheferizeString:useChicken:)];</span><br><span class="line">SetModificationCallback (textManager, <span class="function"><span class="keyword">method</span>, <span class="title">cheferizer</span>);</span></span><br></pre></td></tr></table></figure>
<p>然后你编译器就会有警告:</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">XXCheferizer.m:<span class="number">36</span>:<span class="number">40</span>: warning: incompatible pointer types</span><br><span class="line">   passing <span class="string">'IMP'</span> (aka <span class="string">'id (*)(__strong id, SEL, ...)'</span>)</span><br><span class="line">   <span class="keyword">to</span> parameter <span class="keyword">of</span> <span class="keyword">type</span> <span class="string">'TextManagerCallback'</span> (aka <span class="string">'void (*)(NSString *__strong, BOOL)'</span>)</span><br><span class="line">     [-Wincompatible-pointer-types]</span><br><span class="line">       SetModificationCallback (textManager, <span class="function"><span class="keyword">method</span>, <span class="title">cheferizer</span>);</span></span><br></pre></td></tr></table></figure>
<p>我们回到“怎么把OC方法转化为C回调方法？”这个问题上。 编译器回非常高兴武断的去执行这段代码，而不会顾及这段警告。但我们需要强制去除这些警告，否则在运行时环境里，有些事情却不那么令人兴奋了。-encheferizeString:useChicken: 的参数排列顺序是这样的：</p>
<img src="/images/blog/2013090902.png">  
<p>这和c的执行顺序不一样，下面是对比图<br><img src="/images/blog/2013090903.png"><br><img src="/images/blog/2013090904.png">  </p>
<p>C库传递的参数是  the string，the boolean flag and the info pointer.而自己已经写好的oc方法运行时会传递self 参数，但实际上应该传的 string pointer.依次类推，后面参数全都混乱了</p>
<p>解决方法 </p>
<p>你是怎么解决的呢？ 传递一个包含你要运行的oc方法的object，作为info pointer. 然后 使用一个轻量级的c方法来获取这个object，准备就绪后，你可以像第一个例子那样按照正常的c方法回调使用了。简单代码如下:</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">XXCheferizer</span> *cheferizer = [[XXCheferizer alloc] initWithDialect: kSwedish]<span class="comment">;</span></span><br><span class="line"><span class="label">SetModificationCallback</span> (textManger, encheferizeString,</span><br><span class="line">                         (__bridge void *)cheferizer)<span class="comment">;</span></span><br><span class="line"> NSString *encheferizeString (NSString *<span class="keyword">string, </span><span class="keyword">BOOL </span><span class="keyword">bawkbawk, </span>void *<span class="preprocessor">info</span>) &#123;</span><br><span class="line">    XXCheferizer *<span class="keyword">borkbork </span>= (__bridge id) <span class="preprocessor">info</span><span class="comment">;</span></span><br><span class="line">    [<span class="keyword">borkbork </span>encheferizeString: <span class="keyword">string </span> useChicken: <span class="keyword">bawkbawk]&#125;</span></span><br></pre></td></tr></table></figure>
<p>####一个真实的例子</p>
<p>Core Graphics里面有个数据类型CGShadingRef大家应该都用过，用来填充图形阴影的。CGShadingRef很像CGGradient，但却给你更多的编程空间。 想要使用CGShading 你必须构建一个C方法来供来回调用，当然是在绘图的时候。你可以用参数来控制画多长或者使用哪种颜色。你可以看一个简单的例子- ShadyDeals.（看不看无关紧要）我不会详细的介绍CGShading。 这里是构建阴影的方法。通过参数location（float类型，值范围 0.0-1.0）来实现动态改变颜色组成。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shadingCallback</span> <span class="params">(<span class="keyword">void</span> *info, <span class="keyword">const</span> <span class="keyword">float</span> *location,</span><br><span class="line">                             <span class="keyword">float</span> *results)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">float</span> thing = *location;</span><br><span class="line">    results[<span class="number">0</span>] = thing;  <span class="comment">// Red</span></span><br><span class="line">    results[<span class="number">1</span>] = thing;  <span class="comment">// Green</span></span><br><span class="line">    results[<span class="number">2</span>] = thing;  <span class="comment">// Blue</span></span><br><span class="line">    results[<span class="number">3</span>] = <span class="number">1.0</span>;    <span class="comment">// Alpha</span></span><br><span class="line">&#125; <span class="comment">// shadingCallback</span></span><br></pre></td></tr></table></figure>
<p>效果如下:</p>
<img src="/images/blog/2013090905.png">  
<p>A shader function 是用CGFunctionCreate创建的。它封装了方法指针，你的内容指针，还有一些参数</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CGFunctionCallbacks</span> callback = &#123; <span class="number">0</span>, shadingCallback, <span class="literal">NULL</span> &#125;;</span><br><span class="line"><span class="built_in">CGFunctionRef</span> shaderFunction =</span><br><span class="line">    <span class="built_in">CGFunctionCreate</span> ((__bridge <span class="keyword">void</span> *)<span class="keyword">self</span>,  <span class="comment">// context / info</span></span><br><span class="line">                      <span class="number">1</span>,     <span class="comment">// number of inputs for domain</span></span><br><span class="line">                      domain,</span><br><span class="line">                      <span class="number">4</span>,     <span class="comment">// number of outputs for range</span></span><br><span class="line">                      range,</span><br><span class="line">                      &amp;callback);</span><br></pre></td></tr></table></figure>
<p>代码看起来非常有趣，c回调方法（shadingCallback）首先被封装在一个类似结构体里（这个结构体第一个参数是version，默认是0，第三个为用来释放info指针的回调方法，我们不需要，所以为NULL）。这个结构体用来创建 shader function object，shaderFunction包含了callback，相当于info pointer。在这个例子里info pointer 是self自己，也就是UIView，把自己画在屏幕上，上面假设的例子只不过是把info pointer省略了。</p>
<p>原文链接</p>
<p><a href="http://blog.bignerdranch.com/3727-callin-u-back/" target="_blank" rel="external">http://blog.bignerdranch.com/3727-callin-u-back/</a></p>
<p>相关阅读</p>
<p>objective-c 和C++混编：</p>
<p><a href="http://blog.csdn.net/zhouhuiah/article/details/6426158" target="_blank" rel="external">http://blog.csdn.net/zhouhuiah/article/details/6426158</a></p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/article/20130927/magicalmapping-iosdui-xiang-ying-she/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          MagicalMaping—iOS对象映射
        
      </div>
    </a>
  
  
    <a href="/article/20130620/uitableviewxing-neng-you-hua/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">UITableView性能优化</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>






</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2015 Nidom
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    

<script>
	var yiliaConfig = {
		fancybox: undefined,
		mathjax: undefined,
		animate: undefined,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: undefined
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






  </div>
</body>
</html>